name: E2E Tests

on:
  pull_request:
    branches: [main]

# Add permissions for PR commenting
permissions:
  contents: read
  pull-requests: write

env:
  NODE_VERSION: "20"

jobs:
  e2e-tests:
    name: Run E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Build application
        run: npm run build

      - name: Run Playwright tests
        run: npx playwright test

      - name: Upload test results
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: |
            playwright-report/
            test-results/
          if-no-files-found: warn
          retention-days: 7
          compression-level: 6
          overwrite: true

      - name: Comment PR with Artifact Link
        if: ${{ !cancelled() && github.event_name == 'pull_request' }}
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;

            // Get the specific artifact download URL
            let artifactDownloadUrl = `${runUrl}/artifacts`;
            let playwrightReportUrl = artifactDownloadUrl;

            try {
              // Try to get the specific artifact ID for playwright-report
              const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: ${{ github.run_id }}
              });
              
              const playwrightArtifact = artifacts.data.artifacts.find(artifact => artifact.name === 'playwright-report');
              if (playwrightArtifact) {
                playwrightReportUrl = playwrightArtifact.archive_download_url;
              }
            } catch (error) {
              console.log('Could not fetch specific artifact URL, using general artifacts page');
            }

            const testStatus = '${{ job.status }}' === 'success' ? 'âœ… PASSED' : 'âŒ FAILED';
            const statusIcon = '${{ job.status }}' === 'success' ? 'ðŸŽ‰' : 'ðŸš¨';

            const body = `# ${statusIcon} E2E Test Results

            ## ${testStatus}

            > **ðŸŽ­ Playwright E2E Tests Completed**  
            > **ðŸ“… Run Date**: ${new Date().toLocaleString('en-US', { timeZone: 'UTC' })} UTC  
            > **ðŸ”¢ Run ID**: ${{ github.run_id }}

            ---

            ## ðŸ“Š **DOWNLOAD TEST ARTIFACTS**

            ### ðŸŽ¯ **[Download Playwright Report](${playwrightReportUrl})**

            **What's included in the artifact:**

            | ðŸ“ **Folder** | ðŸ“ **Contents** | ðŸŽ¯ **Purpose** |
            |---------------|------------------|----------------|
            | **ðŸ“¹ Videos** | Complete recordings of each test | See exactly what the app did during tests |
            | **ðŸ“¸ Screenshots** | Failure snapshots | Visual debugging of failed tests |
            | **ðŸ“Š HTML Report** | Interactive test results | Detailed test analysis with embedded media |
            | **ðŸ” Traces** | Step-by-step execution | Debug failed tests with full context |

            ---

            ## ðŸš€ **How to View Results**

            1. **Click** the "Download Playwright Report" link above (may require GitHub login)
            2. **Extract** the downloaded ZIP file to your computer  
            3. **Open** \`playwright-report/index.html\` in your browser
            4. **Navigate** through the interactive report to see videos, traces, and failure details

            ---

            ## ðŸ”— **Additional Links**

            - ðŸ“‹ [**View GitHub Actions Run**](${runUrl}) - Full logs and workflow details
            - ðŸ”§ [**Browse All Artifacts**](${artifactDownloadUrl}) - Complete test output
            - ðŸ“– **Retention**: Artifacts available for **7 days** from run date

            > **Note**: Direct artifact download requires GitHub authentication. If the link doesn't work, visit the Actions run page above and download from there.

            ---

            <sub>ðŸ¤– *This comment is automatically generated after each E2E test run*</sub>`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
