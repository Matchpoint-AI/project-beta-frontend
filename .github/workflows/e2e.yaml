name: E2E Tests

on:
  pull_request:
    branches: [main]

# Add permissions for PR commenting
permissions:
  contents: read
  pull-requests: write

env:
  NODE_VERSION: "20"

jobs:
  e2e-tests:
    name: Run E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Build application
        run: npm run build

      - name: Run Playwright tests
        run: npx playwright test

      - name: Upload test results
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: |
            playwright-report/
            test-results/
          if-no-files-found: warn
          retention-days: 7
          compression-level: 6
          overwrite: true

      - name: Comment PR with Artifact Link
        if: ${{ !cancelled() && github.event_name == 'pull_request' }}
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            const artifactUrl = `${runUrl}/artifacts`;

            const testStatus = '${{ job.status }}' === 'success' ? 'âœ… PASSED' : 'âŒ FAILED';
            const statusIcon = '${{ job.status }}' === 'success' ? 'ğŸ‰' : 'ğŸš¨';

            const body = `# ${statusIcon} E2E Test Results

            ## ${testStatus}

            > **ğŸ­ Playwright E2E Tests Completed**  
            > **ğŸ“… Run Date**: ${new Date().toLocaleString('en-US', { timeZone: 'UTC' })} UTC  
            > **ğŸ”¢ Run ID**: ${{ github.run_id }}

            ---

            ## ğŸ“Š **DOWNLOAD TEST ARTIFACTS**

            ### ğŸ¯ **[Click Here to Download Playwright Report](${artifactUrl})**

            **What's included in the artifact:**

            | ğŸ“ **Folder** | ğŸ“ **Contents** | ğŸ¯ **Purpose** |
            |---------------|------------------|----------------|
            | **ğŸ“¹ Videos** | Complete recordings of each test | See exactly what the app did during tests |
            | **ğŸ“¸ Screenshots** | Failure snapshots | Visual debugging of failed tests |
            | **ğŸ“Š HTML Report** | Interactive test results | Detailed test analysis with embedded media |
            | **ğŸ” Traces** | Step-by-step execution | Debug failed tests with full context |

            ---

            ## ğŸš€ **How to View Results**

            1. **Download** the \`playwright-report\` artifact from the link above
            2. **Extract** the ZIP file to your computer  
            3. **Open** \`index.html\` in your browser
            4. **Navigate** through videos and traces to see test execution

            ---

            ## ğŸ”— **Additional Links**

            - ğŸ“‹ [**View GitHub Actions Run**](${runUrl}) - Full logs and workflow details
            - ğŸ”§ [**Download All Artifacts**](${artifactUrl}) - Complete test output
            - ğŸ“– **Retention**: Artifacts available for **7 days** from run date

            ---

            <sub>ğŸ¤– *This comment is automatically generated after each E2E test run*</sub>`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
